1. Executive Patch Summary
The current system has functional Stripe order creation but lacks durable event logging, manual workflow linking, shipping automation, and email tracking; it also risks duplicate processing due to a legacy webhook path. This patch set adds missing Sanity schema fields and state machines, implements idempotent, signature-verified webhooks with dead-letter handling, and introduces EasyPost label creation plus Resend event tracking. After completion, online orders, manual quote→invoice→order workflows, shipping label generation and tracking updates, and email delivery/open/click tracking become fully functional and auditable in production.

2. Dependency & Ordering Strategy
Order of operations: schema updates → Sanity Studio deploy → Netlify functions (Stripe logging + references) → EasyPost integration (client + label + webhook) → Resend webhook + sendEmail updates → ops cleanup (delete legacy webhook file) → external dashboard updates → documentation/testing.
Blocking prerequisites: schema changes must land before any function writes those fields; Stripe dashboard endpoint must be updated before deleting legacy webhook route.
Must deploy together: Stripe webhook logging + updated stripeWebhookEvent schema; EasyPost webhook + easypostWebhookEvent schema; order fulfillment state machine + create-shipping-label function.
3. Schema Changes (Sanity)
order
Path: order.tsx
Add fields:
fulfillmentStatus (string, grouped fulfillment, required, initial pending)
fulfillmentError (text, readOnly, hidden unless failed states, group fulfillment)
fulfillmentAttempts (number, readOnly, initial 0, group fulfillment)
sourceInvoice (reference to invoice, group technical, hidden)
sourceQuote (reference to quote, group technical, hidden)
Why: enables state-machine visibility for label operations and preserves provenance for manual workflows.
invoice
Path: invoiceContent.tsx
Add fields in relatedDocs fieldset:
sourceQuote (reference to quote, readOnly)
emailLog (reference to emailLog, readOnly)
sentAt (datetime, readOnly)
Why: links invoices to quotes and email delivery audit trail.
quote
Path: quoteContent.tsx
Add fields:
generatedInvoice (reference to invoice, readOnly)
generatedOrder (reference to order, readOnly)
acceptedAt (datetime, readOnly)
Why: establishes bidirectional linkage for manual quote lifecycle without circular writes.
stripeWebhookEvent
Path: stripeWebhookEvent.ts
Add fields: processed (bool), processingStatus, error, errorStack, retryCount, lastRetryAt
Why: dead-letter tracking, replayability, and auditability of Stripe webhook processing.
easypostWebhookEvent
Path: easypostWebhookEvent.ts (new)
Fields per guide: event metadata, payload, processingStatus, error, retryCount
Add to index: index.ts
Why: visibility and dead-letter tracking for shipping webhooks.
emailLog
Path: emailLog.ts (verify fields exist)
Ensure fields used by Resend webhook exist: status, sentAt, deliveredAt, openedAt, clickedAt, clickEvents[], error, emailServiceId
Why: idempotent event updates and reliable email tracking.
shippingLabel
Path: shippingLabel.tsx (verify)
Ensure fields exist for label creation: order ref, trackingNumber, carrier, service, labelUrl, shipmentId, rate, createdAt
Why: shipping artifacts are preserved even if order updates fail.
4. Webhook Architecture Plan
Stripe
Source: Stripe
Function: stripe-webhook.ts
Events: checkout.session.completed, invoice.finalized, invoice.paid, payment_intent.succeeded, charge.succeeded, charge.refunded, payment_intent.canceled
Signature verification: stripe.webhooks.constructEvent with STRIPE_WEBHOOK_SECRET
Idempotency: existing order/session checks + event log; do not create duplicates on replay
Retry handling: log event with processingStatus=processing, update to completed on success; on error increment retryCount, set failed_retrying vs failed_permanent after max; return 500 for retryable, 200 for permanent
Dead-letter: stripeWebhookEvent with error and stack for manual replay
200 vs 500: 200 on success and permanent failure; 500 on retryable failure
EasyPost
Source: EasyPost
Function: easypost-webhook.ts
Events: tracker.created, tracker.updated, shipment.failed
Signature verification: HMAC SHA-256 with EASYPOST_WEBHOOK_SECRET
Idempotency: update by tracking number; use set or setIfMissing to avoid duplicates; log orphan events without failing
Retry handling: same dead-letter logic as Stripe (processingStatus + retryCount)
Dead-letter: easypostWebhookEvent with payload + error; replay through admin tool
200 vs 500: 200 on success and permanent failure; 500 on retryable errors
Resend
Source: Resend
Function: resend-webhook.ts
Events: email.sent, email.delivered, email.opened, email.clicked, email.bounced, email.complained
Signature verification: HMAC SHA-256 with RESEND_WEBHOOK_SECRET
Idempotency: use setIfMissing for timestamps; append clickEvents without duplication logic handled by Sanity
Retry handling: generally return 200 after validation errors; return 500 only for transient Sanity failures
Dead-letter: log failures to function logs; optionally add a resend event log later
200 vs 500: 200 for processed/ignored; 500 for transient storage errors
5. Shipping Label Workflow (State Machine)
Transitions: pending → creating_label → label_created → shipped → delivered; failure path label_creation_failed or failed.
EasyPost API calls: create shipment → select rate → buy label; record EasyPost shipment ID, label URL, carrier/service, tracking number.
Failure handling: always set fulfillmentStatus and fulfillmentError; increment fulfillmentAttempts. If shipment is purchased but Sanity update fails, retain shippingLabel document creation to avoid loss; consider retry with idempotency keyed on EasyPost shipment ID.
Duplicate prevention: before label creation, check if easyPostShipmentId or shippingLabelUrl already exists; short-circuit if label already created.
Tracking updates: EasyPost webhook updates trackingStatus, trackingUpdatedAt, trackingHistory; when status delivered, set fulfillmentStatus to delivered.
Orphaned events: if tracking number not found, log in easypostWebhookEvent with error field but do not fail the webhook.
6. Manual Quote → Invoice → Order Workflow
Quote acceptance: capture acceptedAt when manual acceptance is recorded or invoice created; keep existing “Convert to Invoice” action.
Invoice generation: sourceQuote stored on invoice; generatedInvoice stored on quote.
Order creation: via existing manual invoice action or new function, create order with sourceInvoice + sourceQuote references; update quote with generatedOrder.
Bidirectional references: write each reference once at creation to avoid circular update loops; patch order after invoice creation, not vice versa.
Studio actions: provide “Convert Quote to Order” action that calls a Netlify function, which creates order and sets links in a single controlled flow.
7. Cleanup & Decommissioning
Delete file: webhooks.ts
External endpoints to remove: Stripe Dashboard webhook pointing to /api/webhooks
Legacy routes to retire: Astro webhook route for Stripe
Risk of leaving: duplicate processing, webhook retries to dead endpoint, inconsistent audit trail.
8. Risk & Data Integrity Assessment
Data loss risk: label purchased without Sanity record if patch fails; mitigated via state machine + shippingLabel document creation + retries.
Financial risk: duplicate label purchases or duplicate orders; mitigated by idempotent checks (existing order/session, existing shipment ID/label URL).
Race conditions: multiple webhook retries updating same order; mitigated by idempotent patch operations and setIfMissing patterns.
Audit gaps: lack of event logging; mitigated by stripe/easypost event schemas and processing status tracking.
9. Validation & Testing Plan
Stripe: send checkout.session.completed and confirm stripeWebhookEvent with completed, order created, invoice linked, sourceInvoice set.
EasyPost label flow: create label via function; verify state transitions and shippingLabel doc.
EasyPost webhook: send tracker.updated and verify tracking status update and event log completed.
Resend: send email via sendEmail; fire events; verify emailLog status/timestamps and clickEvents.
Manual order tests: create quote → convert to invoice → convert to order; verify sourceQuote, sourceInvoice, generatedInvoice, generatedOrder.
Failure simulations: force Sanity failure during webhook processing and confirm failed_retrying/failed_permanent behavior.
10. Implementation Readiness Gate
Plan approved by stakeholders and ops.
Sanity schema changes reviewed and scheduled for deploy before function changes.
Stripe legacy endpoint removed from dashboard before deleting the Astro route.
Phase 1 to implement first: schema updates + Stripe webhook logging + order/invoice reference linking.


// ChatGPT PHASE PLANS FOR CODEX //

PHASE 2 — IMPLEMENTATION PROMPT (PATCH-ONLY)

You are Codex operating in patch-only mode.

Read and follow the patch plan in docs/prompts/codex-plan-schema-webhook.txt (sections 1–10). Implement it as written with NO scope expansion.

Hard rules:
- Make ONLY minimal diffs required to implement the plan.
- Do NOT refactor unrelated code.
- Do NOT rename files except where deletion is explicitly required.
- Keep Netlify Functions as the authoritative runtime.
- Every webhook MUST: (1) verify signature first, (2) validate payload (Zod), (3) be idempotent, (4) be retry-safe.
- Add explicit, consistent error logging.
- If any item in the plan cannot be implemented due to missing context in the repo, STOP and output a single “BLOCKER” section listing the exact missing file(s) or unknown schema(s). Do not guess.

Deliverables (implement in this order):

A) Sanity schema updates
1) Update `order` schema (order.tsx):
   - Add: fulfillmentStatus, fulfillmentError, fulfillmentAttempts
   - Add: sourceInvoice (ref invoice, hidden, technical group)
   - Add: sourceQuote (ref quote, hidden, technical group)
2) Update `invoice` schema (invoiceContent.tsx):
   - Add: sourceQuote (ref quote, readOnly)
   - Add: emailLog (ref emailLog, readOnly)
   - Add: sentAt (datetime, readOnly)
3) Update `quote` schema (quoteContent.tsx):
   - Add: generatedInvoice (ref invoice, readOnly)
   - Add: generatedOrder (ref order, readOnly)
   - Add: acceptedAt (datetime, readOnly)
4) Update `stripeWebhookEvent` schema (stripeWebhookEvent.ts):
   - Add: processed, processingStatus, error, errorStack, retryCount, lastRetryAt
5) Add new `easypostWebhookEvent` schema:
   - Create file: easypostWebhookEvent.ts
   - Add to schema index exports (index.ts or equivalent) so Studio recognizes it
   - Fields must include: eventId (string), eventType/description (string), createdAt (datetime), payload (string or object), processingStatus (string), error (string), errorStack (string), retryCount (number), lastRetryAt (datetime)
6) Verify `emailLog` and `shippingLabel` schemas contain all fields referenced by the plan. If missing, add minimally required fields.

B) Stripe webhook fixes + event logging
1) In `netlify/functions/stripe-webhook.ts`:
   - Create a `stripeWebhookEvent` document immediately after signature verification with processingStatus=processing.
   - On success: mark processingStatus=completed, processed=true.
   - On error: increment retryCount, set lastRetryAt, record error + errorStack.
   - Return 500 for retryable failures, 200 for permanent failures.
2) In `checkout.session.completed`:
   - Ensure `order.stripeSummary.data` is populated with the full session payload (stringify if needed).
   - Ensure order is linked to invoice without creating circular write loops:
     - If invoice is created in this handler, patch the order to set `sourceInvoice` to that invoice reference.

C) Decommission legacy Stripe webhook route
1) Delete the legacy Astro route file explicitly called out in the plan: `src/pages/api/webhooks.ts`.
2) Add a short note to docs (or a comment in the plan file) stating the Stripe Dashboard endpoint must be removed/updated.

D) EasyPost integration
1) Create `netlify/functions/create-shipping-label.ts`:
   - Input: { orderId }
   - Fetch order: weight, dimensions, shipping address, existing label fields.
   - State machine updates:
     - If label already exists (easyPostShipmentId or shippingLabelUrl), return success without buying again.
     - Set fulfillmentStatus=creating_label before purchasing.
     - On success: create `shippingLabel` doc AND patch order with trackingNumber, carrier, service, shippingLabelUrl, easyPostShipmentId; set fulfillmentStatus=label_created.
     - On failure: set fulfillmentStatus=label_creation_failed and record fulfillmentError; increment fulfillmentAttempts.
   - Prevent double-purchase by idempotency checks BEFORE calling buy.
2) Create `netlify/functions/easypost-webhook.ts`:
   - Verify signature using EASYPOST_WEBHOOK_SECRET.
   - Validate payload with Zod.
   - Log each webhook to `easypostWebhookEvent` with processingStatus lifecycle and retryCount.
   - Implement tracker.updated (and other required events per plan):
     - Find order by trackingNumber.
     - Patch trackingStatus, trackingUpdatedAt, and trackingHistory as supported by schema.
     - If no order found: mark event log as completed with an orphan note; still return 200.

E) Resend webhook integration
1) Update `netlify/functions/_resend.ts` (or the project’s Resend helper):
   - When sending emails, include tag emailLogId if provided.
2) Create `netlify/functions/resend-webhook.ts`:
   - Verify signature using RESEND_WEBHOOK_SECRET.
   - Validate payload with Zod.
   - Idempotent timestamp updates using setIfMissing where appropriate.
   - For clicked events: append to clickEvents[] and set clickedAt.
   - Update emailLog.status for delivered/opened/clicked/bounced/complained.

F) Minimal docs/testing additions
1) Add or update a short testing checklist file or section (docs/webhooks.md if it already exists; otherwise append to the plan file) covering:
   - Stripe test event and expected Sanity docs
   - EasyPost label creation and tracker.updated
   - Resend delivered/opened/clicked

Acceptance criteria:
- `netlify/functions/stripe-webhook.ts` writes to `stripeWebhookEvent` for every request and correctly updates status on success/failure.
- Legacy route `src/pages/api/webhooks.ts` is removed.
- EasyPost label creation is safe against duplicate purchase and records both an order patch and a shippingLabel doc.
- EasyPost webhook updates tracking fields and logs all events.
- Resend webhook updates emailLog documents and clickEvents.

After changes:
- Run typecheck/lint/tests if the repo has them; otherwise run the project’s standard verification commands and report results.
- Output a final “PATCH SUMMARY” listing every file changed/added/deleted.

Proceed.


