TASK: Implement expired orders customer linking fix.

SOURCE OF TRUTH:
docs/reports/expired-orders-customer-contract-decisions.md

YOUR ROLE:
You are Codex, the implementation executor. You MUST implement ONLY what the contract decisions document explicitly approves. DO NOT deviate, optimize, refactor, or "improve" anything beyond the approved changes.

IMPLEMENTATION SEQUENCE (MUST FOLLOW IN ORDER):

PHASE 1: Schema Change (fas-sanity)
────────────────────────────────────
File: packages/sanity-config/src/schemaTypes/documents/abandonedCheckout.ts
Location: After customerEmail field (line 43)
Action: Add customerRef field

Exact code to add:
```typescript
defineField({
  name: 'customerRef',
  title: 'Customer',
  type: 'reference',
  to: [{type: 'customer'}],
  description: 'Reference to customer who abandoned this checkout',
  readOnly: true,
  weak: true,
}),
```

PHASE 2: Logic Change (fas-cms-fresh)
────────────────────────────────────
File: netlify/functions/reprocessStripeSession.ts
Location: In expired checkout branch, BEFORE upsertAbandonedCheckoutDocument call
Action: Add customer lookup

Pattern to replicate (from audit lines 12-22):
```typescript
if (email) {
  try {
    const customerId = await sanity.fetch<string | null>(
      `*[_type == "customer" && email == $email][0]._id`,
      {email},
    )
    if (customerId) baseDoc.customerRef = {_type: 'reference', _ref: customerId}
  } catch (err) {
    console.warn('reprocessStripeSession: failed to lookup customer by email', err)
  }
}
```

Insert this EXACT logic in the expired checkout branch where baseDoc is being built for abandonedCheckout.

FILES ALLOWED TO CHANGE:
─────────────────────────
✅ packages/sanity-config/src/schemaTypes/documents/abandonedCheckout.ts (schema only)
✅ netlify/functions/reprocessStripeSession.ts (expired branch only)

FILES FORBIDDEN TO CHANGE:
───────────────────────────
❌ packages/sanity-config/src/schemaTypes/documents/order.tsx
❌ packages/sanity-config/src/schemaTypes/documents/customer.ts
❌ Any Desk Structure files
❌ Any query files
❌ Non-expired order creation logic in reprocessStripeSession.ts
❌ All other files

CRITICAL CONSTRAINTS:
─────────────────────
❌ DO NOT modify non-expired order creation logic (upsertOrder function)
❌ DO NOT create customers from abandoned checkouts (only link to existing)
❌ DO NOT make customerRef required (must be optional)
❌ DO NOT change existing abandonedCheckout fields (only add customerRef)
❌ DO NOT add any UX enhancements or Desk Structure changes
❌ DO NOT refactor, rename, or "improve" existing code
❌ DO NOT add comments beyond what exists in the pattern

VALIDATION CHECKLIST:
─────────────────────
After implementation, verify:
□ abandonedCheckout schema has customerRef field (weak reference, read-only)
□ customerRef is placed after customerEmail field
□ Customer lookup logic is IDENTICAL to order flow (no variations)
□ Logic is in expired checkout branch only
□ Non-expired order creation remains unchanged
□ No TypeScript errors
□ No new warnings introduced
□ Lint passes (pnpm lint)
□ Runtime typecheck passes (pnpm exec tsc -p tsconfig.runtime.json)

SUCCESS CRITERIA:
─────────────────
Implementation is complete when:
1. Schema change is deployed to fas-sanity
2. Logic change is deployed to fas-cms-fresh
3. All validation checks pass
4. No files outside the allowed list were modified
5. Non-expired order behavior is unchanged (regression test)

ROLLBACK PLAN:
──────────────
If issues arise:
1. Revert schema change: Remove customerRef field
2. Revert logic change: Remove customer lookup from expired branch
3. Verify non-expired orders still work
4. Report failure and await new contract decisions

BEGIN IMPLEMENTATION:
─────────────────────
Read the contract decisions document first.
Implement Phase 1, then Phase 2, in that exact order.
Report completion with validation checklist results.
