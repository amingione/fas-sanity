TASK: Enforce approved contract decisions in strict enforcement mode.

ENFORCEMENT MODE:
You are operating in NON-INTERACTIVE ENFORCEMENT MODE.
You are not designing, refactoring, or improving code.

SOURCE OF TRUTH (AUTHORITATIVE):
docs/reports/separate-create-shipping-label-vs-fulfill-order-behavior-contract-decisions.md

This document is binding.
No behavior, logic, file, or field may be changed unless explicitly approved there.
No inference, extrapolation, or "reasonable assumption" is allowed.

--------------------------------------------------

ISSUE SUMMARY (REFERENCE ONLY):

"Create Shipping Label" action fails due to invalid /api/create-shipping-label endpoint (404).
"Fulfill Order" action performs excessive behavior (creates label + opens it automatically).

These behaviors must be separated per the contract decisions.

--------------------------------------------------

RULES (STRICT):

- Implement ONLY what is explicitly approved in the contract
- Do NOT infer missing steps or intentions
- Do NOT refactor, optimize, rename, or reorganize code
- Do NOT modify schemas unless explicitly approved (SCHEMA CHANGES: REJECTED)
- Do NOT modify UX or UI unless explicitly approved
- Do NOT introduce new behavior, defaults, or fallbacks
- Do NOT change execution order unless explicitly approved
- Do NOT consolidate logic across actions unless approved
- If approval is unclear or missing, STOP and make no changes

--------------------------------------------------

FILES ALLOWED TO CHANGE (EXACT LIST):

1. packages/sanity-config/src/schemaTypes/actions/orderActions.ts
   - Change: Fix "Create Shipping Label" action backend invocation
   - Change from: POST /api/create-shipping-label
   - Change to: POST /.netlify/functions/easypostCreateLabel
   - Add: Print label confirmation using window.confirm()
   - Remove: Automatic label URL opening (line 201: openUrl(labelUrl))
   - Implementation: Use window.confirm('Open shipping label for printing?') after success alert

2. packages/sanity-config/src/schemaTypes/documents/order.actions.ts
   - Change: Remove label creation from "Fulfill Order" action
   - Change: Remove automatic label URL opening (lines 130-136)
   - Remove: callFn('fulfillOrder', {orderId}) call
   - Add: Sequential browser prompts/confirms for user input
   - Add: Direct Sanity client patch (using getClient())
   - Add: shippingLog append
   - Implementation: Use window.prompt() for tracking, window.confirm() for status

If a required change would touch a file not listed above:
- STOP execution
- Report the file path and reason
- Do NOT modify any files

--------------------------------------------------

FILES FORBIDDEN TO CHANGE:

- All files not explicitly listed above
- netlify/functions/easypostCreateLabel.ts (backend is authoritative, do NOT modify)
- netlify/functions/fulfillOrder.ts (may be simplified later, but out of scope)
- packages/sanity-config/src/schemaTypes/documents/order.tsx (schema unchanged)
- All other schema files
- All API routes in fas-cms-fresh
- All frontend repositories
- src/utils/netlifyHelpers.ts (callNetlifyFunction helper unchanged)

--------------------------------------------------

APPROVED LOGIC CHANGES (EXACT):

CREATE SHIPPING LABEL ACTION:

1. Precondition Checks (KEEP EXISTING):
   - Order saved (doc._id exists)
   - Shipping address exists (doc.shippingAddress)
   - Label NOT already purchased (!doc.labelPurchased)

2. Shipment Data Sourcing (KEEP EXISTING):
   - Use doc.packageDimensions if available
   - Prompt user with defaults if missing: weight: 2, length: 10, width: 8, height: 4
   - Parse and validate user input

3. User Confirmation (KEEP EXISTING):
   - Display confirmation dialog with order details
   - Require explicit confirmation

4. Backend Invocation (CHANGE):
   - OLD: fetch('/api/create-shipping-label', ...)
   - NEW: fetch('/.netlify/functions/easypostCreateLabel', ...)
   - Payload (use packageDetails wrapper):
     {
       orderId: string (without drafts. prefix),
       packageDetails: {
         weight: number,
         dimensions: {length, width, height}
       },
       rateId?: string (from doc.easypostRateId)
     }

5. Response Handling (MODIFY):
   - Display alert with tracking details (KEEP)
   - REMOVE: if (labelUrl) openUrl(labelUrl)
   - ADD: window.confirm('Open shipping label for printing?')
   - If user clicks OK, then openUrl(labelUrl)
   - If user clicks Cancel, do nothing

6. Do NOT Add:
   - Fulfillment status changes
   - Order status changes
   - Customer email notifications
   - Automatic label opening

FULFILL ORDER ACTION:

1. Precondition Checks (KEEP EXISTING):
   - Order status is 'paid'
   - Order is published

2. Fulfillment Prompts (ADD - using browser dialogs):
   - Tracking Number: window.prompt()
     * Message: "Enter tracking number (optional):\n\nLeave empty for manual/in-store fulfillment."
     * Pre-fill with doc.trackingNumber if exists
     * If user cancels (null), abort and call onComplete()
   - Fulfillment Status: window.confirm()
     * Message: "Mark order as shipped?\n\nClick OK to mark as SHIPPED.\nClick Cancel to mark as PROCESSING."
     * OK → fulfillmentStatus = 'shipped'
     * Cancel → fulfillmentStatus = 'processing'
   - Notes (optional): Can be omitted for simplicity

3. Backend Invocation (CHANGE):
   - REMOVE: const res = await callFn('fulfillOrder', {orderId})
   - REMOVE: Label creation logic
   - REMOVE: Label URL opening (lines 130-136)
   - ADD: Direct Sanity client patch using getClient()
   - Implementation:
     * Get client: const client = getClient({apiVersion: SANITY_API_VERSION})
     * Patch order: await client.patch(orderId).set({...}).append('shippingLog', [...]).commit()
   - NO external API calls (only Sanity mutation)

4. Order Patch (EXACT):
   - Set:
     * status: 'fulfilled'
     * 'fulfillment.status': fulfillmentStatus
     * shippedAt: new Date().toISOString()
     * trackingNumber: trackingNumber || existing
     * fulfillmentNotes: notes || undefined
   - Append to shippingLog[]:
     {
       _type: 'shippingLogEntry',
       status: 'fulfilled',
       message: 'Order marked as fulfilled by [user]',
       trackingNumber: trackingNumber || undefined,
       createdAt: timestamp
     }

5. Customer Notification (REMOVED):
   - Email sending is NOT handled by this action
   - Users can manually trigger email via existing "Send Shipping Confirmation" action
   - Keeps action focused on state changes only

6. Response Handling (SIMPLIFY):
   - Display alert: "Order marked as fulfilled."
   - Call onComplete()

7. Do NOT Add:
   - EasyPost API calls
   - Label creation logic
   - Automatic label URL opening
   - Required tracking number validation
   - EasyPost dependency checks
   - Email sending logic (removed from scope)

--------------------------------------------------

VALIDATION REQUIRED:

- TypeScript must compile without errors
- Lint must pass (npm run lint or tsc --noEmit)
- Existing governance rules must remain intact
- No new warnings or errors introduced
- No new network calls added (except changing label endpoint to /.netlify/functions/easypostCreateLabel)
- No new dependencies added (use existing Sanity client, browser APIs)
- No behavior coupling introduced:
  * Label creation does NOT trigger fulfillment
  * Fulfillment does NOT trigger label creation
  * Fulfillment does NOT send emails
- Runtime behavior must match the approved contract exactly:
  * Create Shipping Label: Calls /.netlify/functions/easypostCreateLabel
  * Create Shipping Label: Requires user confirm() before opening label
  * Fulfill Order: Uses direct Sanity client patch (no Netlify function)
  * Fulfill Order: Does NOT create labels
  * Fulfill Order: Does NOT send emails
  * Fulfill Order: Allows fulfillment without tracking

--------------------------------------------------

DATA INTEGRITY INVARIANTS (ENFORCE):

1. labelPurchased flag:
   - Remains controlled by backend (easypostCreateLabel.ts)
   - Action disablement logic unchanged

2. Fulfillment independence:
   - Orders CAN be fulfilled without labels
   - Orders CAN have labels without fulfillment
   - fulfillment.status and shippingLabelUrl are independent

3. Tracking number authority:
   - Existing tracking numbers NOT overwritten unless explicitly changed
   - Manual tracking entry allowed

4. Order status lifecycle:
   - Label creation: status remains 'paid'
   - Fulfillment: status changes to 'fulfilled'

5. Shipping log integrity:
   - Each label creation: append one entry with status: 'label_created'
   - Each fulfillment: append one entry with status: 'fulfilled'
   - Do NOT modify or delete existing log entries

6. Email notification rules:
   - Label creation: NO emails
   - Fulfillment: Email ONLY if trackingNumber exists AND notifyCustomer === true

--------------------------------------------------

FORBIDDEN CHANGES (EXPLICIT):

Schema Changes:
- Do NOT add labelPurchased (already exists)
- Do NOT add fulfillmentMethod, fulfillmentType
- Do NOT add top-level workflowStatus
- Do NOT change shippingStatus type (object to string)
- Do NOT change shippingLog type (array to object)
- Do NOT rename labelPurchased to labelCreated

Backend Function Changes:
- Do NOT modify createEasyPostLabel() signature
- Do NOT add required parameters to easypostCreateLabel.ts
- Do NOT remove metadata fields from EasyPost payloads
- Do NOT change fulfillOrder.ts (out of scope)

Coupling:
- Do NOT require label creation before fulfillment
- Do NOT automatically trigger fulfillment after label creation
- Do NOT fail fulfillment if EasyPost unavailable

Integration Breaks:
- Do NOT change EasyPost webhook handling
- Do NOT modify shippingLogEntry type definition
- Do NOT alter fulfillment.status enum values

UI Changes:
- Do NOT add "EasyPost Settings" section to order form
- Do NOT expose EasyPost shipment IDs in action labels
- Do NOT hardcode carrier names in fulfillment dropdown

--------------------------------------------------

IMPLEMENTATION ORDER (REQUIRED):

1. Fix "Create Shipping Label" endpoint invocation
   - Change fetch URL from /api/create-shipping-label to /.netlify/functions/easypostCreateLabel
   - Remove automatic openUrl(labelUrl) call
   - Add explicit "Print Label" button/prompt

2. Modify "Fulfill Order" action
   - Remove fulfillOrder function call that creates labels
   - Add fulfillment modal/dialog component
   - Implement direct Sanity patch for state update

3. Test both actions independently
   - Verify "Create Shipping Label" calls correct endpoint
   - Verify label creation does NOT change order status
   - Verify "Fulfill Order" works without labels
   - Verify both actions can be performed in any order

--------------------------------------------------

SUCCESS CRITERIA (BINARY):

✅ "Create Shipping Label" successfully calls /.netlify/functions/easypostCreateLabel
✅ Label creation does NOT change order.status from 'paid'
✅ Label creation does NOT send customer emails
✅ Label URL requires user confirm() before opening (not automatic)
✅ "Fulfill Order" uses direct Sanity client patch (no Netlify function call)
✅ "Fulfill Order" uses browser prompts/confirms for user input
✅ "Fulfill Order" does NOT create labels
✅ "Fulfill Order" does NOT send emails
✅ "Fulfill Order" allows fulfillment without tracking numbers
✅ Fulfillment can be completed for orders without labels
✅ Both actions can be performed independently in any order
✅ No schema fields modified
✅ No new dependencies added
✅ TypeScript compiles without errors
✅ Lint passes without new warnings

--------------------------------------------------

COMPLETION RULE:

When enforcement is complete:
- Stop execution
- Do NOT suggest improvements
- Do NOT explain changes beyond "Contract enforced per [contract file]"
- Do NOT modify additional files
- Do NOT continue work beyond approved scope
- Do NOT propose future enhancements
- Do NOT add TODO comments or feature flags

If any criterion cannot be met with approved changes only:
- STOP immediately
- Report the blocking issue
- Do NOT make partial changes
- Do NOT work around the limitation
