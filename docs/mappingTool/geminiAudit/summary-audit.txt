✦ 1. EXECUTIVE SUMMARY (1–2 paragraphs)

  The audit reveals systemic failures in API contract enforcement and webhook handling, leading to a high risk of data corruption, failed transactions,
  and operational instability. The dominant failure pattern is a complete lack of idempotency guards across virtually all webhook handlers. This exposes
  the system to dangerous duplicate processing from service retries, which could result in duplicate shipments, erroneous emails, and incorrect financial
  records.

  Furthermore, a secondary pattern of missing pre-flight validation is prevalent. The application consistently attempts to call external
  services—primarily EasyPost and Resend—without first verifying that required data fields are present. This guarantees API call failures, wastes
  resources, and creates debugging challenges. Compounding these issues is evidence of schema drift, where the application's data model for persisted
  entities in Sanity has fallen out of sync with the data being processed from external services, leading to the loss of critical tracking and message
  identifiers.

  ---

  2. ROOT CAUSE GROUPING

  A. Missing Idempotency Guards
   - Pattern: Webhook endpoints lack a mechanism to verify if an incoming event has been processed before. They treat every incoming request as novel,
     executing business logic without checking for duplication.
   - Danger: Service providers like Stripe and EasyPost will retry sending webhooks if they don't receive a timely success confirmation. Without
     idempotency guards, these retries will trigger duplicate actions (e.g., fulfilling an order multiple times, sending the same email repeatedly,
     creating multiple customer records). This is a critical defect that can lead to significant financial and reputational damage.
   - Affected Subsystems: The issue is systemic and affects nearly all asynchronous ingress points, including Netlify functions, API routes, and internal
     scripts responsible for handling events from external services.

  B. API Contract Violations (by Service)
   - Stripe
     - Violation: While no direct missingField violations were reported for Stripe, the high number of Stripe-related webhooks lacking idempotency guards
       (stripeWebhook, stripe-order, etc.) implies a high risk of processing duplicate payment and order events.
   - EasyPost
     - Missing Fields: to_address, from_address, parcel.
     - Location: netlify/functions/fulfillOrder.ts, src/pages/api/create-shipping-label.ts.
     - Enforcement Failure: The code does not validate that these fundamental shipment objects exist and are properly structured before attempting to call
       the EasyPost shipment.create endpoint. The absence of this check guarantees the API call will fail.
   - Resend
     - Missing Fields: to, from, subject.
     - Location: Multiple Netlify functions (requestFreightQuote.ts, send-email-test.ts, sendCustomerEmail.ts, sendVendorEmail.ts) and API routes.
     - Enforcement Failure: The system attempts to dispatch emails via the Resend API without first ensuring that the basic required fields for sending an
       email are populated. This results in failed email delivery and lost customer or vendor communications.

  C. Schema Drift / Persistence Mismatches
   - Drift: The audit identifies a clear mismatch between the data fields the application logic attempts to process and the fields defined in the Sanity
     CMS schema. Specifically, identifiers returned from successful API calls are not being persisted.
   - Identified Fields:
     - EasyPost: easyPostShipmentId, trackingNumber, shippingLabelUrl.
     - Resend: resendMessageId, messageId.
   - Persistence Risks: By failing to persist these identifiers, the system breaks its ability to correlate internal records with external service
     entities. It becomes impossible to track a shipment's status using its EasyPost ID or to follow up on a customer email using its Resend message ID.
     This is a critical data integrity failure.

  ---

  3. FILE-LEVEL FIX MAP (MOST IMPORTANT)

   - FILE: /Users/ambermin/LocalStorm/Workspace/DevProjects/GitHub/fas-sanity/netlify/functions/fulfillOrder.ts
     - ISSUE TYPE: missingField
     - LINE(S): 210
     - REQUIRED FIX:
       - Before calling the EasyPost shipment creation function, add a validation block.
       - This block must check that the to_address, from_address, and parcel objects are not null or undefined and contain the required nested fields as
         per EasyPost API documentation.
       - If validation fails, log an error detailing the missing fields and return a 400 status code immediately.
     - SERVICE IMPACTED: EasyPost

   - FILE: /Users/ambermin/LocalStorm/Workspace/DevProjects/GitHub/fas-sanity/netlify/functions/requestFreightQuote.ts
     - ISSUE TYPE: missingField
     - LINE(S): 324
     - REQUIRED FIX:
       - Before calling the Resend send function, add a validation guard.
       - This guard must ensure the to and from fields are non-empty strings and conform to email format.
       - If validation fails, log an error specifying which field is missing and return a 400 status code.
     - SERVICE IMPACTED: Resend

   - FILE: /Users/ambermin/LocalStorm/Workspace/DevProjects/GitHub/fas-sanity/netlify/functions/send-email-test.ts
     - ISSUE TYPE: missingField
     - LINE(S): 94
     - REQUIRED FIX:
       - Before the Resend API call, implement a check to verify that to and from are valid, non-empty email addresses.
       - If either field is invalid, prevent the API call, log the error, and terminate the function with a failure response.
     - SERVICE IMPACTED: Resend

   - FILE: /Users/ambermin/LocalStorm/Workspace/DevProjects/GitHub/fas-sanity/netlify/functions/sendCustomerEmail.ts
     - ISSUE TYPE: missingField
     - LINE(S): 59
     - REQUIRED FIX:
       - Prior to invoking the Resend service, add a guard that confirms the to and subject fields are populated with non-empty strings.
       - If the check fails, log a detailed error message and return a 400 status code to the caller.
     - SERVICE IMPACTED: Resend

   - FILE: /Users/ambermin/LocalStorm/Workspace/DevProjects/GitHub/fas-sanity/netlify/functions/sendVendorEmail.ts
     - ISSUE TYPE: missingField
     - LINE(S): 48
     - REQUIRED FIX:
       - Before attempting to send an email, add a validation step to ensure the to field contains a valid email address string.
       - If the to field is missing or invalid, abort the operation, log an error, and return an appropriate error code.
     - SERVICE IMPACTED: Resend

   - FILE: /Users/ambermin/LocalStorm/Workspace/DevProjects/GitHub/fas-sanity/src/pages/api/create-shipping-label.ts
     - ISSUE TYPE: missingField
     - LINE(S): 183
     - REQUIRED FIX:
       - Before creating the EasyPost shipment, add a check to ensure the parcel object is defined and contains necessary attributes like weight or
         dimensions.
       - If the parcel data is missing, the function must not proceed with the API call and should return a 400 Bad Request response with a descriptive
         error.
     - SERVICE IMPACTED: EasyPost

   - FILE: /Users/ambermin/LocalStorm/Workspace/DevProjects/GitHub/fas-cms-fresh/src/pages/api/webhooks.ts
     - ISSUE TYPE: payloadAccess
     - LINE(S): 162
     - REQUIRED FIX:
       - Before accessing fields on the webhook payload, implement a schema-based validation (e.g., using Zod).
       - This validation should parse the incoming body to ensure it conforms to the expected structure.
       - If parsing fails, the handler must stop execution and return a 400 error. Only access fields on the validated, parsed object.
     - SERVICE IMPACTED: Stripe

   - ALL FILES listed in `webhook-drift-report.json` (multiple files)
     - ISSUE TYPE: idempotency
     - LINE(S): Various
     - REQUIRED FIX:
       - At the beginning of each webhook handler function, implement an idempotency check.
       - Extract a unique event identifier from the incoming webhook request headers or body (e.g., Stripe-Signature, EasyPost event id).
       - Query Sanity for a document of a new schema type (e.g., processedWebhookEvent) with this unique identifier.
       - If a document is found, immediately return a 200 OK response to prevent the service from retrying.
       - If no document is found, create one with the event ID and a status of processing, then proceed with the function's business logic. Upon
         completion, update the document's status to completed.
     - SERVICE IMPACTED: Stripe, EasyPost, Sanity, and others

   - Sanity Schema Definitions (file path not provided, likely in
     `/Users/ambermin/LocalStorm/Workspace/DevProjects/GitHub/fas-sanity/packages/sanity-config/src/schemaTypes/documents/`)
     - ISSUE TYPE: schemaMismatch
     - LINE(S): N/A
     - REQUIRED FIX:
       - For EasyPost: Locate the Sanity schema for shipments (likely shipment.tsx). Add the following fields:
         - easyPostShipmentId (type: string)
         - trackingNumber (type: string)
         - shippingLabelUrl (type: url)
       - For Resend: Locate the schema where email logs are stored or create a new one (e.g., emailLog.ts). Add the following fields:
         - resendMessageId (type: string)
     - SERVICE IMPACTED: Sanity, EasyPost, Resend

  ---

  4. REQUIRED SYSTEM-WIDE PATTERNS TO IMPLEMENT

   - Standard Idempotency Guard Pattern for Webhooks
     - Inputs: The full webhook request object (headers and body).
     - Guards:
       1. Create a dedicated processedWebhookEvent schema in Sanity with fields for eventId (string, unique), source (string, e.g., 'stripe', 'easypost'),
          status ('processing', 'completed', 'failed'), and createdAt.
       2. In each webhook handler, extract the unique event ID from the request.
       3. Perform an atomic create-if-not-exists operation in Sanity for a document with that eventId.
       4. If the document already existed, log a "Duplicate event ignored" message and return 200 OK.
       5. If the document was created, proceed with the business logic.
     - Failure Behavior: If the business logic fails, update the event document's status to failed and log the error context. This prevents retries on
       permanent failures and aids debugging.
     - Logging: Log the event ID at the start of processing and log whether the event was a duplicate, a success, or a failure.

   - Required Field Validation Strategy Before API Calls
     - Strategy: Adopt a schema-based, fail-fast validation approach for all data intended for external API calls.
     - Implementation:
       1. For each external service call (e.g., EasyPost shipment.create, Resend email.send), define a strict validation schema (e.g., using Zod) that
          mirrors the service's required request body.
       2. Before making the API call, parse the input data object using this schema.
       3. If parsing fails, immediately throw an error or return a 400 Bad Request response. The error message must include the specific validation
          failures reported by the parser.
       4. Do not wrap the API call in a try/catch block to handle missing fields; catch them before the call is ever made.

   - Schema Alignment Enforcement
     - Strategy: The Sanity schema must be the single source of truth for all data persisted from external services.
     - Implementation:
       1. All data persisted from external API responses (e.g., a shipment from EasyPost, a payment intent from Stripe) MUST be explicitly mapped to a
          corresponding Sanity schema type.
       2. Any new identifier or piece of metadata from a service that needs to be stored (e.g., easyPostShipmentId) requires a corresponding field to be
          added to the relevant Sanity schema before application code is updated to persist it.
       3. Utilize TypeScript types generated from the Sanity schema to ensure type safety when preparing data for persistence.

  ---

  5. CODEX HANDOFF SUMMARY (FINAL SECTION)

  Codex, your immediate priority is to patch critical data integrity and transaction-related flaws in the system. The audit has revealed widespread,
  severe issues that must be addressed to prevent data corruption and operational failures.

  You must fix the following issues in this specific order:

   1. Correct Schema Mismatches: First, update the Sanity schemas to include the missing fields for EasyPost (easyPostShipmentId, trackingNumber, etc.)
      and Resend (resendMessageId). This is the top priority as it prevents the loss of critical data from subsequent fixes.
   2. Implement API Validations: Next, add pre-flight validation guards to every function that makes an external API call to EasyPost or Resend. Ensure
      all required fields (to_address, parcel, to, subject, etc.) are present and valid before the API call is made. This will stop the flood of
      guaranteed-to-fail API requests.
   3. Deploy Idempotency Guards: Finally, systematically implement the standard idempotency guard pattern across all identified webhook handlers. This is
      a large but critical task that will protect the system from processing duplicate events.

  If these fixes are not applied, the system will remain unstable. It will continue to fail to create shipping labels and send emails, and more
  dangerously, it will be susceptible to creating duplicate orders, shipments, and customer communications, which can have direct financial consequences.
  Begin with the schema changes immediately.