# Cross-Repo Data Flow (fas-sanity ⇄ fas-cms-fresh)

Table key: Source of Truth (SoT) reflects the primary system of record.

| Entity | Source of Truth | Reads (fas-cms-fresh) | Writes (fas-cms-fresh / fas-sanity) | Risks |
|--------|----------------|----------------------|-------------------------------------|-------|
| **Customers** | Sanity `customer` docs; Stripe for `stripeCustomerId` and discounts | • `src/pages/api/get-customer-profile.ts`<br>• `src/pages/api/customer/get.ts`<br>• `src/lib/customer.ts`<br>• `src/server/sanity-client.ts` | • Create/update: `src/pages/api/auth/signup.ts`, `src/pages/api/customer/update.ts`, `src/pages/api/webhooks.ts`<br>• Stripe sync + discount sync: `netlify/functions/stripeWebhook.ts`, `netlify/functions/createCustomerDiscount.ts` | • Reads assume fields not in schema (`fullName`, `vehicle`, `notes`, `quotes` in `src/lib/customer.ts`)<br>• Writes include legacy `address` string and `billingAddress` object without schema alignment<br>• Stripe customer ID flow only in Sanity-side webhooks, not in fas-cms-fresh writes |
| **Vendors** | Sanity `vendor` docs (company + portal access) | • `src/server/sanity-client.ts`<br>• `src/pages/api/vendor/login.ts`<br>• `src/pages/api/vendor/me.ts`<br>• `src/pages/api/vendor/settings/*`<br>• `src/pages/api/vendor/messages/*` | • Updates: `src/pages/api/vendor/settings/profile.ts`, `src/pages/api/vendor/settings/addresses.ts`, `src/pages/api/vendor/settings/notifications.ts`<br>• Auth tokens/portal access: `src/server/vendor-portal/service.ts` | • Reads/writes reference top-level `name`/`email` fields not defined in vendor schema<br>• Vendor auth tokens use `_type == "vendorAuthToken"` with no schema in fas-sanity<br>• `getVendorBySub` expects `userSub` field not defined in schema |
| **Orders** | Stripe checkout sessions + Sanity `order` docs; EasyPost for shipment state | • `src/pages/api/get-user-order.ts`<br>• `src/pages/api/orders/[id].ts`<br>• `src/pages/api/vendor/orders/[id].ts`<br>• `src/server/vendor-portal/data.ts` | • Creates: `src/pages/api/webhooks.ts`, `src/pages/api/save-order.ts`<br>• Patches: `src/pages/api/shipping/create-label.ts`, `src/pages/api/orders/[id].ts`, `src/pages/api/admin/orders/[id].ts`, `netlify/functions/easypostWebhook.ts` | • Order status values written as `pending` in `src/pages/api/save-order.ts` are not in schema list<br>• Wholesale orders use `customerRef` as vendor reference (schema expects customer)<br>• EasyPost webhook writes `shippingStatus` + `shippingLog` fields not in order schema |
| **Invoices** | Sanity `invoice` docs | • `src/pages/api/get-user-invoices.ts`<br>• `src/pages/api/vendor/invoices/[id].ts`<br>• `src/server/vendor-portal/data.ts` | • Patch payments: `src/pages/api/vendor/invoices/[id]/pay.ts` | • Queries assume `customerEmail`, `customer` reference, and order fields (`shippingCarrier`, `selectedService`, `shippingLog`) not defined in schemas<br>• Vendor invoice queries rely on `references($vendorId)` but invoice schema has no vendor reference |
| **Quotes** | Sanity `quote`, `quoteRequest`, and `buildQuote` docs | • `src/pages/api/get-user-quotes.ts` | • Creates: `src/pages/api/save-quote.ts` (buildQuote), `src/pages/api/build-quote.ts` + `src/server/sanity/quote-requests.ts` (quoteRequest) | • Reads target `_type == "quote"`, but writes create `buildQuote` and `quoteRequest`<br>• Query fields (`notes`, `customerRef`) do not exist in `quote` schema |
| **Discounts / Coupons** | Stripe coupons/discounts; Sanity customer `discounts[]` array | • Studio derived list: `packages/sanity-config/src/structure/discountsList.tsx`<br>• fas-cms-fresh promotions: `src/server/sanity/promotions.ts`, `src/lib/storefrontQueries.ts`, `src/pages/api/promotions/*` | • Stripe discount creation + sync: `netlify/functions/createCustomerDiscount.ts` → `netlify/lib/customerDiscounts.ts` | • fas-cms-fresh expects `promotion` documents but no matching schema in fas-sanity<br>• Two parallel discount models (Stripe-customer discounts vs promotion docs) without a shared contract |
| **Messages** | Sanity `customerMessage` and `vendorMessage` docs | • Vendor portal: `src/pages/api/vendor/messages/index.ts`, `src/pages/api/vendor/messages/[id].ts` | • Vendor messages create/reply: `src/pages/api/vendor/messages/*`<br>• SMS notifications: `netlify/functions/notify-sms.ts` (reads `customerMessage`/`vendorMessage` payloads) | • `vendorMessage` is marked deprecated in schema but is still written/read by the vendor portal |

