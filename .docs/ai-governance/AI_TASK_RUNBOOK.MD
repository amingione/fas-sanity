AI TASK EXECUTION RUNBOOK — fas-sanity (Authoritative)

PREREQUISITES

- Repo: fas-sanity
- Branch clean and up to date
- Netlify CLI authenticated
- Required env vars present (from JSON secrets)
- Governance docs already updated (e.g. PROD_IDENTIFICATION_RULES.md)

---

## STEP 1 — CREATE / IDENTIFY TASK

Choose or create a task identifier (string-safe, no spaces).

Example:
task = "sku-json-secrets-enforcement"

If the task was generated by AI or audit, confirm scope and files touched.

---

## STEP 2 — RUN GATED EXECUTION (OPTIONAL ENTRY)

If using the gated entry command:

pnpm run ai:gated --task <task> --prompt "<intent>"

This prepares the workspace but DOES NOT approve or apply anything.

---

## STEP 3 — APPROVE TASK (HUMAN REQUIRED)

Approve the task explicitly. This generates an immutable approval token:

pnpm run ai:approve --task <task>

This creates:
APPROVED:<task>:<commitSha>

No task may be applied without this approval artifact.

---

## STEP 4 — APPLY / TEST / DEPLOY

Execute the approved task:

pnpm run ai:apply --task <task>

This performs, in order:

1. Applies scoped changes
2. Runs tests
3. Runs drift check
4. Commits changes
5. Deploys via Netlify CLI
6. Captures deploy metadata

---

## STEP 5 — DEPLOY CAPTURE (AUTOMATIC)

During deploy, Netlify CLI is run with --json.
The following artifacts are written automatically:

.ai-stack-trace/<task>/deploy.log
.ai-stack-trace/<task>/final/status.json

status.json contains:

- deployUrl
- deployId
- context: "autoTest"
- commitSha
- timestamp

---

## STEP 6 — COMPLETION / GOVERNANCE

If behavior changed intentionally:

- Create or backfill a completedTask record in Sanity
- Reference:
  - task id
  - commitSha
  - deployUrl
  - governance doc (e.g. PROD_IDENTIFICATION_RULES.md)
- Mark as intentional drift where applicable

---

## RULES (NON-NEGOTIABLE)

- No apply without approve
- No deploy without captured metadata
- No reversion of completedTask behavior
- No legacy behavior reinstated without a new task
- Secrets must be JSON (Netlify contract)
- Governance docs are authoritative

END RUNBOOK
